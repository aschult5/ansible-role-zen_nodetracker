---
- name: Install Tracker Container
  docker_container:
    name: "{{ secnode_tracker_svc_name }}"
    image: "aschultz5/zen-nodetracker:{{ secnode_tracker_ver|d('latest') }}"
    state: present
    restart_policy: unless-stopped
    user: "{{ zennode_user_id|d(omit,true) }}"
    log_driver: journald
    env:
      ZENCONF: /mnt/zen/zen.conf
    volumes:
      - "{{ secnode_tracker_dir }}/config:/home/node/app/config"
      - "{{ zennode_zen_dir }}:/mnt/zen:ro"
    networks:
      - name: "{{ container_net_name }}"

- name: Tracker Service File
  copy:
    dest: "/lib/systemd/system/{{ secnode_tracker_svc_name }}.service"
    owner: root
    content: |
      [Unit]
      Description=ZenCash nodetracker
      Requires={{ zennode_zend_svc_name }}.service
      After={{ zennode_zend_svc_name }}.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/bin/docker start {{ secnode_tracker_svc_name }}
      ExecStop=/usr/bin/docker stop {{ secnode_tracker_svc_name }}

      [Install]
      WantedBy=multi-user.target
  notify:
    - systemd daemon-reload

- name: Enable Tracker Service
  service:
    name: "{{ secnode_tracker_svc_name }}.service"
    enabled: yes
